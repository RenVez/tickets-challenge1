<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Соревнование по тикетам</title>
<style>
body {
  font-family: Arial, sans-serif;
  background: #1e1e2e;
  color: #eee;
  padding: 20px;
  display: flex;
  flex-direction: column;
  align-items: center;
}
h1 {
  color: #00ffae;
}
#board {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  width: 90%;
  max-width: 800px;
  margin-top: 20px;
}
.user {
  background: #2b2b3b;
  border-radius: 10px;
  padding: 15px;
  text-align: center;
  transition: 0.3s;
}
.count {
  font-size: 2em;
  color: #00ffae;
  margin: 10px 0;
}
button {
  padding: 8px 14px;
  border: none;
  border-radius: 6px;
  background: #4a90e2;
  color: white;
  cursor: pointer;
  margin: 5px;
  font-size: 16px;
}
button:disabled {
  background: #555;
  cursor: not-allowed;
}
input {
  padding: 6px 10px;
  border-radius: 5px;
  border: none;
  margin-right: 5px;
}
.winner {
  background: #ffd700;
  color: #000;
}
.timer {
  font-size: 1.2em;
  margin-top: 5px;
  color: #ffda75;
}
</style>
</head>
<body>
<h1>Соревнование по тикетам</h1>

<div>
  <input id="usernameInput" placeholder="Ваше имя">
  <button id="joinBtn">Войти</button>
</div>

<div id="board"></div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();
let username = null;

const usernameInput = document.getElementById('usernameInput');
const joinBtn = document.getElementById('joinBtn');
const board = document.getElementById('board');

joinBtn.onclick = () => {
  username = usernameInput.value.trim();
  if (!username) return alert("Введите имя!");
  socket.emit('join', username);
  usernameInput.disabled = true;
  joinBtn.disabled = true;
};

socket.on('updateState', participants => {
  board.innerHTML = '';
  let maxCount = Math.max(...Object.values(participants).map(p => p.count), 0);

  for (let u in participants) {
    const p = participants[u];
    const div = document.createElement('div');
    div.className = 'user';
    if (p.count === maxCount && maxCount > 0) div.classList.add('winner');
    div.innerHTML = `
      <div><strong>${u}</strong></div>
      <div class="count">${p.count}</div>
    `;

    // Только свой блок интерактивен
    if (u === username) {
      const timeInput = document.createElement('input');
      timeInput.type = 'number';
      timeInput.placeholder = 'Минуты';
      timeInput.min = '1';
      timeInput.style.width = '80px';

      const startBtn = document.createElement('button');
      startBtn.textContent = '▶ Старт';
      startBtn.onclick = () => {
        const mins = parseInt(timeInput.value);
        if (isNaN(mins) || mins <= 0) return alert('Введите время в минутах!');
        socket.emit('startSelfTimer', { username, seconds: mins * 60 });
      };

      const ticketBtn = document.createElement('button');
      ticketBtn.textContent = '+1 тикет';
      ticketBtn.disabled = !p.running;
      ticketBtn.onclick = () => socket.emit('increment', username);

      const timerDisplay = document.createElement('div');
      timerDisplay.className = 'timer';
      timerDisplay.textContent = p.running
        ? `⏱ Осталось: ${formatTime(p.remaining)}`
        : '⏳ Таймер не запущен';

      div.appendChild(timeInput);
      div.appendChild(startBtn);
      div.appendChild(ticketBtn);
      div.appendChild(timerDisplay);
    } else if (p.running) {
      const timerDisplay = document.createElement('div');
      timerDisplay.className = 'timer';
      timerDisplay.textContent = `⏱ Осталось: ${formatTime(p.remaining)}`;
      div.appendChild(timerDisplay);
    }
    board.appendChild(div);
  }
});

function formatTime(sec) {
  const m = Math.floor(sec / 60);
  const s = sec % 60;
  return `${m}:${s.toString().padStart(2, '0')}`;
}
</script>
</body>
</html>
